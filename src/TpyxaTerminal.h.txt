#ifndef TpyxaTerminal_h
#define TpyxaTerminal_h

//#include "Arduino.h"
//#include <WiFi.h>

#define MAXofTELNET 32

// Внутренние типы клиентов
#define CLIENT_TYPE_UNDEFINED 0
#define CLIENT_TYPE_TEXT      1
#define CLIENT_TYPE_BASE   2
#define CLIENT_TYPE_GRAPHIC   3
#define CLIENT_TYPE_DISCONNECTED -1


#define WiFi_CLOSED      0
#define WiFi_LISTEN      1
#define WiFi_SYN_SENT    2
#define WiFi_SYN_RCVD    3
#define WiFi_ESTABLISHED 4
#define WiFi_FIN_WAIT_1  5
#define WiFi_FIN_WAIT_2  6
#define WiFi_CLOSE_WAIT  7
#define WiFi_CLOSING     8
#define WiFi_LAST_ACK    9
#define WiFi_TIME_WAIT   10

#define CLIENT_TIMEOUT 180000
#define WRITE_TIMEOUT 1000

class TpyxaTerminal : public Print {
	public:
		TpyxaTerminal(uint16_t port = 23); // Конструктор с портом по умолчанию 23

		void begin();
		void toDisplay(char *text);
		void toDisplay(const char *text);
		void toBase(char *text);
		void toBase(const char *text);
		
		
		//void terminal();
		void task_handler();
		void task_handler(bool exeCom);
		
		//terminalClear
		void clearBuffers();
		
		// Реализация Print
		size_t write(uint8_t byte) override;
		size_t write(const uint8_t *buffer, size_t size) override;
		
		// Отладка в Serial
		void debugON();
		void debugOFF();
		int nClient(); // Количесво клиентов
		
		// Дополнительные пользовательские команды
		int userCommand(String command);			// По умолчанию пустой, нужно переопределять
		void SetClient(int ClientIndex); // Установка текущего клиента
		void SetCommandCallback(UserCommandCallback callback);
		typedef void (*UserCommandCallback)(String command);

		
	private:
		UserCommandCallback _UserCommandCallback = nullptr;		// Указатель на функцию доп команд
		int _nCurrentClient; // Номер текущего клиента
		bool _debugSerial;
		uint16_t _port; // Запомним порт
		WiFiServer _telnetServer;

		WiFiClient		_ClientTelnet[MAXofTELNET];
		int				_ClientType[MAXofTELNET]; // 0-неопределен 1-текстовый терминал 2-графичекий терминал
		unsigned long	_ClientTime[MAXofTELNET]; // Время последнего обмена
		
		//void terminal_start3();
		void _acceptNewClient();
		
		// void processCommand(String command, int tc);
		void _processCommand(String command);
		void _freeDisconnectedSlots();
		void _freeSlot(int i);
		void _addClient(int i, WiFiClient &newC);

};

#endif // TpyxaTerminal_h
