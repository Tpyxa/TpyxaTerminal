#include <Arduino.h>
#include <WiFi.h>
#include <TpyxaTerminal.h>

//WiFiServer telnetServer(23);
//WiFiClient telnetClient[MAXofTELNET];
//int typeTelnet[MAXofTELNET]; // 0-неопределен 1-текстовый терминал 2-графичекий терминал


TpyxaTerminal::TpyxaTerminal(uint16_t port):_telnetServer(port), _port(port){
    for(int i=0;i<MAXofTELNET;i++) { _ClientType[i] = CLIENT_TYPE_DISCONNECTED; _ClientTime[i]=millis(); }
	_debugSerial = false;
	_nCurrentClient = -1; // Текущий клиент не определен
}
void TpyxaTerminal::debugON(){ _debugSerial = true; }
void TpyxaTerminal::debugOFF(){ _debugSerial = false; }
		
void TpyxaTerminal::begin(){
	_telnetServer.begin(); // Поднимаем сервер telneta
	if(_debugSerial) Serial.println("TelnetServer start");
}
// Подключение нового клиента
void TpyxaTerminal::_acceptNewClient()
{
    WiFiClient newClient = _telnetServer.accept();
    // Если есть терминальный клиент
    if (newClient)
    {
        newClient.setTimeout(10); // Таймаут вайфай пакетов
        newClient.setNoDelay(true);

        for(int i=0;i<MAXofTELNET;i++)
        {
			// Ищем пустой слот клиента
            if((!_ClientTelnet[i]) || _ClientType[i]==CLIENT_TYPE_DISCONNECTED)
            {
				_addClient(i, &newClient);
                return;
            }
        }
		// Не нашли пустой слот, ищем самый старый
		unsigned long oldslot_time = 0;
		int oldslot_index = -1;
		for(int i=0;i<MAXofTELNET;i++)
		{
			if(_ClientTime[i] > oldslot_time)
			{
				oldslot_index = i;
				oldslot_time = _ClientTime[i];
			}
		}
		if(oldslot_index>-1)
		{
			_freeSlot(oldslot_index);
			_addClient(oldslot_index, &newClient);
		}
		else if(_debugSerial) Serial.printf("ERROR: NO FREE SLOT");
    }
}
void TpyxaTerminal::_addClient(int i, WiFiClient &newC){
	//Serial.print("New client "); Serial.println(i);
	_ClientTelnet[i]=newC;
	_ClientTelnet[i].printf("Add Client-%d#", i);
	if(_debugSerial)
	{
		Serial.printf("Add Client-%d IP: %s\n", i, IPAddress(_ClientTelnet[i].remoteIP()).toString().c_str());
		//Serial.printf("MAC: %s\n", i, _ClientTelnet[i].softAPmacAddress());
		
	} // uint32_t remoteIP() localIP()
	
	_ClientType[i] = CLIENT_TYPE_UNDEFINED; // Поначалу тип клиента неизвестен
	_ClientTime[i]=millis();
	
}
// Вывод в разные терминалы
void TpyxaTerminal::toDisplay(char *text){
    //text[strlen(text)] = '#'; text[strlen(text)+1] = 0; 
    for(int i=0;i<MAXofTELNET;i++)
        if (_ClientTelnet[i] && _ClientTelnet[i].connected() && _ClientType[i]==CLIENT_TYPE_TEXT) // Если есть клиент и он соединен и явл текст терм
            _ClientTelnet[i].println(text);
}
void TpyxaTerminal::toDisplay(const char *text){
    //text[strlen(text)] = '#'; text[strlen(text)+1] = 0; 
    for(int i=0;i<MAXofTELNET;i++)
        if (_ClientTelnet[i] && _ClientTelnet[i].connected() && _ClientType[i]==CLIENT_TYPE_TEXT) // Если есть клиент и он соединен и явл текст терм
            _ClientTelnet[i].println(text);
}
void TpyxaTerminal::toBase(char *text){
    //text[strlen(text)] = '#'; text[strlen(text)+1] = 0; 
    int b=0;
    for(int i=0;i<MAXofTELNET;i++)
        if (_ClientTelnet[i] && _ClientTelnet[i].connected() && _ClientType[i]==CLIENT_TYPE_BASE) // Если есть клиент и он соединен и явл текст терм
            {
                _ClientTelnet[i].println(text);
                b++;
            }
}
void TpyxaTerminal::toBase(const char *text){
    //text[strlen(text)] = '#'; text[strlen(text)+1] = 0; 
    for(int i=0;i<MAXofTELNET;i++)
        if (_ClientTelnet[i] && _ClientTelnet[i].connected() && _ClientType[i]==CLIENT_TYPE_BASE) // Если есть клиент и он соединен и явл текст терм
            _ClientTelnet[i].println(text);
}

int TpyxaTerminal::userCommand(String command, int clientIndex){ return 0; }
void TpyxaTerminal::_processCommand(String command, int tc) {
  command.trim();  // Удаление лишних пробелов в начале и конце строки
  //Serial.printf("Gx=%d Gy=%d CMD: ", Gx, Gy);
  if(_debugSerial) Serial.println(command);
  //toDisplay(command.c_str());
  //telnetClient[tc].print(command.c_str());
  
  if (command.startsWith("ID:TEXT")){
     _ClientType[tc] = CLIENT_TYPE_TEXT; // Переключаем тип клиента
     _ClientTelnet[tc].println("TextTerm registered#");

    // Текстовый терминал может быть только один (пока)
    for(int i=0;i<MAXofTELNET;i++)
        if (i!=tc) // Проверяем всех кроме текущего
            if(_ClientType[i] == CLIENT_TYPE_TEXT) // Нашли фантомный терминал
				_freeSlot(i);
  }
  else if (command.startsWith("ID:BASE")){
     _ClientType[tc] = CLIENT_TYPE_BASE; // Переключаем тип клиента
     _ClientTelnet[tc].println("BASE registered#");

    // База может быть только одна
    for(int i=0;i<MAXofTELNET;i++)
        if (i!=tc) // Проверяем всех кроме текущего
            if(_ClientType[i] == CLIENT_TYPE_BASE) // Нашли фантомную базу
				_freeSlot(i);
  }
  else if (command.startsWith("PING")) {
    _ClientTelnet[tc].println("OK#");
    toDisplay("PING OK#");
  }
  else {
	// Вызов пользовательских команд
	if(!userCommand(command, tc))
		if(_debugSerial) Serial.println("Unknown command");
  }
}

// Бывш terminal
void TpyxaTerminal::task_handler(){ task_handler(false); }
void TpyxaTerminal::task_handler(bool exeCom)
{
    _acceptNewClient(); // Ищем новых клиентов
    // Прием команд
    if(exeCom)
    for(int i=0;i<MAXofTELNET;i++)
    {
        if (_ClientTelnet[i] && _ClientTelnet[i].available() > 0)
        {
            String command = _ClientTelnet[i].readStringUntil('#');  // Чтение команды до символа
            if(command.length()>3) _processCommand(command, i);  // Обработка команды
			_ClientTime[i]=millis();
        }
    }
	_freeDisconnectedSlots();

}
void TpyxaTerminal::_freeDisconnectedSlots(){
    // Освобождение клиентских слотов
    for(int i=0;i<MAXofTELNET;i++)
		 // Если есть клиент
        if (_ClientTelnet[i])
		{
			//auto status = _ClientTelnet[i].status();
			// Смотрим за что бы его выкинуть
			if(!_ClientTelnet[i].connected()) // Не подсоединен
			{
				if(_debugSerial) Serial.print("Not connect: ");
				_freeSlot(i); continue;
			}
			if(_ClientTelnet[i].available() < 0) // Не доступен
			{
				if(_debugSerial) Serial.print("Not available: ");
				_freeSlot(i); continue;
			}
			if((millis()-_ClientTime[i]) > CLIENT_TIMEOUT) // Долго ничего не посылает
			{
				if(_debugSerial) Serial.print("TimeOut: ");
				_freeSlot(i); continue;
			}
			/*
			if(status == WiFi_CLOSED || status == WiFi_CLOSE_WAIT || status == WiFi_TIME_WAIT || status == WiFi_FIN_WAIT_1) // WiFi статус
			{
				if(_debugSerial) Serial.print("WiFi: ");
				_freeSlot(i); continue;
			}
			*/
			
			/*
			uint8_t dummy[1];
			//size_t written = _ClientTelnet[i].write(&dummy, 1); // Блокирует программу
			_ClientTelnet[i].readBytes(dummy, 0);
			if(_ClientTelnet[i].peek() < 0)
			{
				if(_debugSerial) Serial.print("dummy: ");
				_freeSlot(i); continue;
			}
			*/
			//_ClientTelnet[i].println("123#");
		}
}
void TpyxaTerminal::_freeSlot(int i){
	if(_debugSerial) Serial.printf("disconnect %d\n", i);
    if(_ClientTelnet[i]) _ClientTelnet[i].stop();
    _ClientTelnet[i] = WiFiClient(); // Замещаем пустым классом для корректных проверок
    _ClientType[i] = CLIENT_TYPE_DISCONNECTED; // Переключаем тип клиента
}
int TpyxaTerminal::nClient(){
	int k=0;
	for(int i=0;i<MAXofTELNET;i++)
		if(_ClientType[i] != CLIENT_TYPE_DISCONNECTED)
			k++;
	return k;
}
// Очистка буферов телнет-клиентов
void TpyxaTerminal::clearBuffers()
{
    char rb[4];
    for(int i=0;i<MAXofTELNET;i++)
    {
        if (_ClientTelnet[i] && _ClientTelnet[i].available() > 0)
        {
            while(_ClientTelnet[i].available() > 0) _ClientTelnet[i].readBytes(rb, 1);
        }
    }
}
size_t TpyxaTerminal::write(uint8_t byte) {
    // Отправляем байт во все подключенные текстовые терминалы
    size_t written = 0;
    for(int i = 0; i < MAXofTELNET; i++) {
        if (_ClientTelnet[i] && _ClientTelnet[i].connected() && _ClientType[i] == CLIENT_TYPE_TEXT) {
            written += _ClientTelnet[i].write(byte);
        }
    }
    return written;
}

size_t TpyxaTerminal::write(const uint8_t *buffer, size_t size) {
    // Отправляем блок байт во все подключенные текстовые терминалы
    size_t total_written = 0;
    for(int i = 0; i < MAXofTELNET; i++) {
        if (_ClientTelnet[i] && _ClientTelnet[i].connected() && _ClientType[i] == CLIENT_TYPE_TEXT) {
            total_written += _ClientTelnet[i].write(buffer, size);
        }
    }
    return total_written;
}

